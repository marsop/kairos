@page "/activities"
@using Kairos.Shared.Models
@using Kairos.Shared.Services
@using Kairos.Shared.Resources
@inject ITimeTrackingService TimeService
@inject IStringLocalizer<Strings> Localizer
@implements IDisposable

<div class="activities-page">
    <h2 class="page-title">@Localizer["NavActivities"]</h2>
    
    <div class="activities-grid">
        @{
            var orderedActivities = TimeService.Account.Activities.OrderBy(m => m.DisplayOrder).ToList();
        }
        @for (var index = 0; index < orderedActivities.Count; index++)
        {
            var activity = orderedActivities[index];
            var isActive = IsActiveActivity(activity.Id);
            var isEditing = _editingActivityId == activity.Id;
            var isDragging = _draggedActivity?.Id == activity.Id;
            var isDragOver = _dragTargetActivityId.HasValue && _dragTargetActivityId.Value == activity.Id && _draggedActivity?.Id != activity.Id;

            <div draggable="@(isEditing ? "false" : "true")"
                 class="activity-container @(isDragging ? "dragging" : "") @(isDragOver ? "drag-over" : "")"
                 @ondragstart="() => HandleDragStart(activity)"
                 @ondragenter="() => HandleDragEnter(activity)"
                 @ondragover="HandleDragOver"
                 @ondragover:preventDefault
                 @ondrop="() => HandleDrop(activity)"
                 @ondragend="HandleDragEnd"
                 @ondragleave="HandleDragLeave">
                @if (isEditing)
                {
                    <div class="activity-edit-form">
                        <input type="text" 
                               class="activity-name-input @(_validationError != null ? "invalid" : "")"
                               @bind="_editingActivityName"
                               @bind:event="oninput"
                               @onkeydown="HandleEditKeyDown"
                               @onblur="SaveEdit"
                               maxlength="40"
                               autofocus />
                        <div class="edit-actions">
                            <button class="edit-action-btn save" @onclick="SaveEdit" title="@Localizer["Save"]">‚úì</button>
                            <button class="edit-action-btn cancel" @onclick="CancelEdit" @onclick:stopPropagation="true" title="@Localizer["Cancel"]">‚úï</button>
                        </div>
                        @if (_validationError != null)
                        {
                            <div class="validation-error">@_validationError</div>
                        }
                        <div class="char-count @(_editingActivityName?.Length > 40 ? "over-limit" : "")">
                            @(_editingActivityName?.Length ?? 0)/40
                        </div>
                    </div>
                }
                else
                {
                    <button class="activity-button @(isActive ? "active" : "") positive"
                            @onclick="() => ToggleActivity(activity.Id)">
                        <div class="activity-index">#@(index + 1)</div>
                        <div class="activity-name">@activity.Name</div>
                        <div class="activity-status">
                            @if (isActive)
                            {
                                <span class="pulse"></span>
                                <span>@Localizer["Running"]</span>
                            }
                            else
                            {
                                <span>@Localizer["TapToStart"]</span>
                            }
                        </div>
                    </button>
                    <div class="activity-actions">
                        <button class="activity-action-btn" @onclick="() => StartEditing(activity)" @onclick:stopPropagation="true" title="@Localizer["RenameActivity"]">
                            ‚úèÔ∏è
                        </button>
                        @if (!isActive)
                        {
                            <button class="activity-action-btn delete" @onclick="() => DeleteActivity(activity)" @onclick:stopPropagation="true" title="@Localizer["DeleteActivity"]">
                                üóëÔ∏è
                            </button>
                        }
                    </div>
                }
            </div>
        }
        
        @if (TimeService.Account.Activities.Count < Kairos.Shared.Services.TimeTrackingService.MaxActivities)
        {
        <div class="activity-container add-activity">
            @if (_isAddingActivity)
            {
                <div class="activity-edit-form">
                    <input type="text" 
                           class="activity-name-input"
                           placeholder="@Localizer["Name"]"
                           @bind="_newActivityName"
                           maxlength="40"
                           autofocus />
                           
                    <div class="edit-actions">
                        <button class="edit-action-btn save" @onclick="SaveNewActivity" title="@Localizer["Add"]">‚úì</button>
                        <button class="edit-action-btn cancel" @onclick="CancelAdd" title="@Localizer["Cancel"]">‚úï</button>
                    </div>
                    
                    @if (_addValidationError != null)
                    {
                        <div class="validation-error">@_addValidationError</div>
                    }
                </div>
            }
            else
            {
                <button class="activity-button add-activity-btn" @onclick="StartAdding">
                    <div class="add-icon">+</div>
                    <div class="add-text">@Localizer["AddActivity"]</div>
                </button>
            }
        </div>
        }
    </div>
    
    @if (ActiveEvent != null)
    {
        <div class="active-info">
            <div class="active-duration">
                <span class="label">@Localizer["RunningFor"]</span>
                <span class="value">@FormatDuration(ActiveEvent.Duration)</span>
            </div>
        </div>
    }
</div>

@if (_startCommentActivityId.HasValue)
{
    <div class="modal-overlay" @onclick="CancelStartComment">
        <div class="modal-dialog" @onclick:stopPropagation="true">
            <h3>@Localizer["StartActivityCommentTitle"]</h3>
            <p>@Localizer["StartActivityCommentPrompt"]</p>
            <div class="edit-form">
                <div class="edit-field">
                    <label class="edit-label">@Localizer["Comment"]</label>
                    <input type="text"
                           class="edit-input @(_startCommentError != null ? "invalid" : "")"
                           @bind="_startComment"
                           @bind:event="oninput"
                           maxlength="250"
                           @onkeydown="HandleStartCommentKeyDown"
                           autofocus />
                </div>
                @if (!string.IsNullOrWhiteSpace(_startCommentError))
                {
                    <p class="edit-error">@_startCommentError</p>
                }
                <div class="char-count @(_startComment.Length > 250 ? "over-limit" : "")">
                    @_startComment.Length/250
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" @onclick="CancelStartComment">@Localizer["Cancel"]</button>
                <button class="btn-save" @onclick="ConfirmStartComment">@Localizer["Start"]</button>
            </div>
        </div>
    </div>
}

@code {
    private ActivityEvent? ActiveEvent => TimeService.GetActiveEvent();
    
    private System.Threading.Timer? _timer;
    private Guid? _editingActivityId;
    private string? _editingActivityName;
    private string? _validationError;

    // Add Activity State
    private bool _isAddingActivity;
    private string _newActivityName = string.Empty;
    private string? _addValidationError;
    private Guid? _startCommentActivityId;
    private string _startComment = string.Empty;
    private string? _startCommentError;

    // Drag and Drop State
    private Activity? _draggedActivity;
    private Guid? _dragTargetActivityId;

    protected override void OnInitialized()
    {
        TimeService.OnStateChanged += StateHasChanged;
        
        // Update every second to show running duration
        _timer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(StateHasChanged);
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private bool IsActiveActivity(Guid activityId)
    {
        var activeEvent = ActiveEvent;
        if (activeEvent == null) return false;
        
        var activity = TimeService.Account.Activities.FirstOrDefault(m => m.Id == activityId);
        return activity != null && activeEvent.ActivityName == activity.Name;
    }

    private void ToggleActivity(Guid activityId)
    {
        if (IsActiveActivity(activityId))
        {
            TimeService.DeactivateActivity();
        }
        else
        {
            StartActivityWithComment(activityId);
        }
    }

    private void StartActivityWithComment(Guid activityId)
    {
        _startCommentActivityId = activityId;
        _startComment = string.Empty;
        _startCommentError = null;
        CancelEdit();
        CancelAdd();
    }

    private void CancelStartComment()
    {
        _startCommentActivityId = null;
        _startComment = string.Empty;
        _startCommentError = null;
    }

    private void ConfirmStartComment()
    {
        if (!_startCommentActivityId.HasValue)
        {
            return;
        }

        var comment = _startComment.Trim();
        if (comment.Length < TimeTrackingService.MinCommentLength || comment.Length > TimeTrackingService.MaxCommentLength)
        {
            _startCommentError = Localizer["CommentLengthError"];
            return;
        }

        try
        {
            TimeService.ActivateActivity(_startCommentActivityId.Value, comment);
            CancelStartComment();
        }
        catch (ArgumentException ex)
        {
            _startCommentError = ex.Message;
        }
    }

    private void HandleStartCommentKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            ConfirmStartComment();
        }
        else if (e.Key == "Escape")
        {
            CancelStartComment();
        }
    }

    private void StartEditing(Activity activity)
    {
        _editingActivityId = activity.Id;
        _editingActivityName = activity.Name;
        _validationError = null;
        CancelAdd();
    }

    private void SaveEdit()
    {
        if (_editingActivityId == null || _editingActivityName == null)
        {
            CancelEdit();
            return;
        }

        var trimmedName = _editingActivityName.Trim();
        
        if (trimmedName.Length < 1 || trimmedName.Length > 40)
        {
            _validationError = Localizer["NameLengthError"];
            return;
        }

        try
        {
            TimeService.RenameActivity(_editingActivityId.Value, trimmedName);
            CancelEdit();
        }
        catch (ArgumentException ex)
        {
            _validationError = ex.Message;
        }
    }

    private void CancelEdit()
    {
        _editingActivityId = null;
        _editingActivityName = null;
        _validationError = null;
    }

    private void HandleEditKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            SaveEdit();
        }
        else if (e.Key == "Escape")
        {
            CancelEdit();
        }
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalHours >= 1)
        {
            return Localizer["DurationLong", (int)duration.TotalHours, duration.Minutes];
        }
        else if (duration.TotalMinutes >= 1)
        {
            return Localizer["DurationShort", (int)duration.TotalMinutes, duration.Seconds];
        }
        else
        {
            return Localizer["DurationSeconds", (int)duration.TotalSeconds];
        }
    }

    private void DeleteActivity(Activity activity)
    {
        if (IsActiveActivity(activity.Id)) return;
        TimeService.DeleteActivity(activity.Id);
    }
    
    // Add Activity Logic
    private void StartAdding()
    {
        _isAddingActivity = true;
        _newActivityName = string.Empty;
        _addValidationError = null;
        CancelEdit();
    }

    private void CancelAdd()
    {
        _isAddingActivity = false;
        _newActivityName = string.Empty;
        _addValidationError = null;
    }

    private void SaveNewActivity()
    {
        if (string.IsNullOrWhiteSpace(_newActivityName))
        {
            _addValidationError = Localizer["NameRequired"];
            return;
        }
        
        try
        {
            TimeService.AddActivity(_newActivityName);
            CancelAdd();
        }
        catch (Exception ex)
        {
            _addValidationError = ex.Message;
        }
    }

    // Drag and Drop Handlers

    private void HandleDragStart(Activity activity)
    {
        _draggedActivity = activity;
        _dragTargetActivityId = null;
    }

    private void HandleDragEnter(Activity activity)
    {
        if (_draggedActivity == null || _draggedActivity.Id == activity.Id) return;
        _dragTargetActivityId = activity.Id;
    }

    private void HandleDragLeave()
    {
        // No-op: we only clear on DragEnd or Drop to avoid flicker from child elements
    }

    private void HandleDragOver(DragEventArgs e)
    {
        e.DataTransfer.DropEffect = "move";
    }

    private void HandleDragEnd()
    {
        _draggedActivity = null;
        _dragTargetActivityId = null;
    }

    private void HandleDrop(Activity targetActivity)
    {
        if (_draggedActivity == null || _draggedActivity.Id == targetActivity.Id)
        {
            _draggedActivity = null;
            _dragTargetActivityId = null;
            return;
        }

        // Compute the reorder: remove dragged from original position, insert at target position
        var activities = TimeService.Account.Activities.OrderBy(m => m.DisplayOrder).ToList();
        var draggedIndex = activities.FindIndex(m => m.Id == _draggedActivity.Id);
        var targetIndex = activities.FindIndex(m => m.Id == targetActivity.Id);

        if (draggedIndex != -1 && targetIndex != -1)
        {
            var dragged = activities[draggedIndex];
            activities.RemoveAt(draggedIndex);
            activities.Insert(targetIndex, dragged);
            TimeService.ReorderActivities(activities.Select(m => m.Id).ToList());
        }

        _draggedActivity = null;
        _dragTargetActivityId = null;
    }

    public void Dispose()
    {
        TimeService.OnStateChanged -= StateHasChanged;
        _timer?.Dispose();
    }
}
