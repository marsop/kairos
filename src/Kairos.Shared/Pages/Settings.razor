@page "/settings"
@using Kairos.Shared.Services
@using Microsoft.JSInterop
@inject ISettingsService SettingsService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<Strings> Localizer
@inject ITimeTrackingService TimeService
@inject ITutorialService TutorialService
@inject IJSRuntime JSRuntime
@inject ITimeularService TimeularService
@inject INotificationService NotificationService
@implements IDisposable

<div class="settings-page">
    <h1 class="page-title">@Localizer["NavSettings"]</h1>

    <div class="settings-section">
        <h2 class="section-title">‚öôÔ∏è @Localizer["NavSettings"]</h2>
        <div class="setting-item">
            <span class="setting-label">@Localizer["DisplayLanguage"]</span>
            <div class="language-dropdown">
                <button type="button" class="dropdown-trigger" @onclick="ToggleDropdown">
                    <span class="flag-icon">@GetFlag(SelectedLanguage)</span>
                    <span>@GetLanguageName(SelectedLanguage)</span>
                </button>
                <div class="dropdown-menu @(isDropdownOpen ? "show" : "")">
                    @foreach (var lang in Languages)
                    {
                        <div class="dropdown-item @(SelectedLanguage == lang.Code ? "selected" : "")"
                             @onclick="() => SelectLanguage(lang.Code)"
                             @onclick:stopPropagation="true">
                            <span class="flag-icon">@lang.Flag</span>
                            <span>@lang.Name</span>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="setting-item">
            <span class="setting-label">@Localizer["TutorialAvatar"]</span>
            <div class="language-dropdown">
                <button type="button" class="dropdown-trigger" @onclick="ToggleAvatarDropdown">
                    <span>@SelectedAvatarName</span>
                </button>
                <div class="dropdown-menu @(isAvatarDropdownOpen ? "show" : "")">
                    @foreach (var avatar in TutorialService.AvailableAvatars)
                    {
                        <div class="dropdown-item @(TutorialService.CurrentAvatar.Id == avatar.Id ? "selected" : "")"
                             @onclick="() => SelectAvatar(avatar.Id)"
                             @onclick:stopPropagation="true">
                            <span>@avatar.Name</span>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="setting-item">
            <div>
                <span class="setting-label">@Localizer["BrowserNotifications"]</span>
                <span class="setting-description" style="display: block; margin-top: 2px;">@Localizer["BrowserNotificationsDesc"]</span>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" checked="@SettingsService.BrowserNotificationsEnabled" @onchange="OnBrowserNotificationsToggled" />
                <span class="toggle-slider"></span>
            </label>
        </div>

        @if (browserNotificationsDenied)
        {
            <div class="status-message error" style="margin-top: var(--spacing-sm);">
                @Localizer["BrowserNotificationsDenied"]
            </div>
        }
    </div>

    <div class="settings-section">
        <h2 class="section-title">üßä Timeular</h2>
        <p class="setting-description">Connect your Timeular device. Face index maps to meter index (for example, Face 3 activates meter #3).</p>

        @if (!string.IsNullOrWhiteSpace(TimeularService.DeviceName))
        {
            <div class="timeular-device-info">
                <span class="info-icon">üì∂</span>
                <span>Selected device: @TimeularService.DeviceName</span>
            </div>
        }

        @if (TimeularService.HasConnectedBefore)
        {
            <div class="timeular-connection-indicator">
                <span class="timeular-connection-light @(TimeularService.IsConnecting ? "connecting" : (TimeularService.IsConnected ? "connected" : "disconnected"))"></span>
                <span>
                    Tracker status:
                    @(TimeularService.IsConnecting ? "Connecting..." : (TimeularService.IsConnected ? "Connected" : "Disconnected"))
                </span>
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(TimeularService.AutoReconnectMessage))
        {
            <div class="timeular-auto-reconnect-message @TimeularService.AutoReconnectClass">
                @TimeularService.AutoReconnectMessage
            </div>
        }

        <div class="timeular-actions">
            <button class="sync-button timeular-connect-btn" @onclick="ConnectTimeularDevice" disabled="@TimeularService.IsConnecting">
                <span class="btn-icon">üîó</span>
                <span>@(TimeularService.IsConnecting ? "Connecting..." : (TimeularService.IsConnected ? "Reconnect Timeular" : "Connect Timeular"))</span>
            </button>

            @if (TimeularService.IsConnected)
            {
                <button class="sync-button timeular-disconnect-btn" @onclick="DisconnectTimeularDevice">
                    <span class="btn-icon">üîå</span>
                    <span>Disconnect</span>
                </button>
            }
        </div>

        @if (!string.IsNullOrWhiteSpace(TimeularService.StatusMessage))
        {
            <div class="status-message @TimeularService.StatusClass">
                @TimeularService.StatusMessage
            </div>
        }

        @if (TimeularService.ChangeLog.Count > 0)
        {
            <div class="timeular-log">
                <div class="timeular-log-title">Recent device changes</div>
                <ul class="timeular-log-list">
                    @foreach (var entry in TimeularService.ChangeLog)
                    {
                        <li class="timeular-log-item">
                            <span class="timeular-log-time">@entry.At.ToLocalTime().ToString("HH:mm:ss")</span>
                            <span class="timeular-log-text">@entry.Message</span>
                        </li>
                    }
                </ul>
            </div>
        }
    </div>

    <div class="settings-section">
        <h2 class="section-title">@Localizer["About"]</h2>
        <div class="setting-item">
            <span class="setting-label">@Localizer["Version"]</span>
            <span class="setting-value">1.0.0</span>
        </div>
    </div>

    <div class="settings-section">
        <h2 class="section-title">@Localizer["Support"]</h2>
        <p class="setting-description">@Localizer["SupportDesc"]</p>
        <button class="support-btn" @onclick="OpenBuyMeACoffee">
            <span class="btn-icon">‚òï</span>
            <span>@Localizer["BuyMeACoffee"]</span>
        </button>
    </div>

    <Kairos.Shared.Components.ConfirmationDialog
        IsVisible="@showConfirmation1"
        Title="@Localizer["FactoryReset"]"
        Message="@Localizer["PromptReset"]"
        OnClose="OnConfirm1" />

    <Kairos.Shared.Components.ConfirmationDialog
        IsVisible="@showConfirmation2"
        Title="@Localizer["FinalWarning"]"
        Message="@Localizer["FinalWarningMsg"]"
        OnClose="OnConfirm2" />

    <div class="settings-section danger-zone">
        <h2 class="section-title">@Localizer["FactoryReset"]</h2>
        <p class="setting-description">@Localizer["FactoryResetDesc"]</p>
        <button class="reset-btn" @onclick="RequestReset">
            <span class="btn-icon">‚ö†Ô∏è</span>
            <span>@Localizer["ResetApp"]</span>
        </button>
    </div>
</div>

@code {
    private bool isDropdownOpen;
    private bool isAvatarDropdownOpen;
    private bool showConfirmation1;
    private bool showConfirmation2;
    private bool browserNotificationsDenied;

    private string SelectedLanguage => SettingsService.Language;

    private record LanguageOption(string Name, string Code, RenderFragment Flag);

    private static readonly RenderFragment FlagEn = @<svg viewBox="0 0 640 480"><rect width="640" height="480" fill="#012169"/><path d="M75 0l245 180L565 0h75v60L395 240l245 180v60h-75L320 300 75 480H0v-60l245-180L0 60V0h75z" fill="#fff"/><path d="M424 281l216 159v40L369 281h55zM216 199L0 41v40l161 118h55zm0 82L0 439v40l216-159v-40zm208-82l216-159V41L424 199h0z" fill="#C8102E"/><path d="M240 0v480h160V0H240zM0 160v160h640V160H0z" fill="#fff"/><path d="M280 0v480h80V0h-80zM0 200v80h640v-80H0z" fill="#C8102E"/></svg>;
    private static readonly RenderFragment FlagDe = @<svg viewBox="0 0 5 3"><rect width="5" height="3" y="0" fill="#000"/><rect width="5" height="2" y="1" fill="#D00"/><rect width="5" height="1" y="2" fill="#FFCE00"/></svg>;
    private static readonly RenderFragment FlagEs = @<svg viewBox="0 0 750 500"><rect width="750" height="500" fill="#c60b1e"/><rect width="750" height="250" y="125" fill="#ffc400"/><path d="M120 150 a60 60 0 0 0 0 120 v30 a30 30 0 0 0 60 0 v-30 a60 60 0 0 0 0 -120 z" fill="#c60b1e" opacity="0.5"/></svg>;
    private static readonly RenderFragment FlagGl = @<svg viewBox="0 0 3 2"><rect width="3" height="2" fill="#fff"/><path d="M0 2L3 0" stroke="#009edb" stroke-width="0.4"/></svg>;
    private static readonly RenderFragment FlagVo = @<svg viewBox="0 0 2 1"><rect width="2" height="1" fill="#fff"/><rect width="2" height="0.5" y="0.5" fill="#f00"/></svg>;

    private List<LanguageOption> Languages = new()
    {
        new("English", "en", FlagEn),
        new("Deutsch", "de", FlagDe),
        new("Espa√±ol", "es", FlagEs),
        new("Galego", "gl", FlagGl),
        new("Vorarlbergerisch", "gsw", FlagVo)
    };

    private string GetLanguageName(string code) => Languages.FirstOrDefault(l => l.Code == code)?.Name ?? "English";
    private RenderFragment GetFlag(string code) => Languages.FirstOrDefault(l => l.Code == code)?.Flag ?? FlagEn;

    protected override void OnInitialized()
    {
        SettingsService.OnSettingsChanged += StateHasChanged;
        TutorialService.OnChange += StateHasChanged;
        TimeularService.OnStateChanged += OnTimeularStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await TimeularService.InitializeAsync();
        }
    }

    public void Dispose()
    {
        SettingsService.OnSettingsChanged -= StateHasChanged;
        TutorialService.OnChange -= StateHasChanged;
        TimeularService.OnStateChanged -= OnTimeularStateChanged;
    }

    private void ToggleDropdown() => isDropdownOpen = !isDropdownOpen;

    private async Task SelectLanguage(string code)
    {
        if (SelectedLanguage == code)
        {
            isDropdownOpen = false;
            return;
        }

        await SettingsService.SetLanguageAsync(code);
        isDropdownOpen = false;
        NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
    }

    private void ToggleAvatarDropdown() => isAvatarDropdownOpen = !isAvatarDropdownOpen;
    private string SelectedAvatarName => TutorialService.CurrentAvatar?.Name ?? "Unknown";

    private async Task SelectAvatar(string avatarId)
    {
        await TutorialService.SetAvatarAsync(avatarId);
        isAvatarDropdownOpen = false;
    }

    private async Task ConnectTimeularDevice() => await TimeularService.ConnectAsync();
    private async Task DisconnectTimeularDevice() => await TimeularService.DisconnectAsync();

    private void OnTimeularStateChanged() => _ = InvokeAsync(StateHasChanged);

    private async Task OnBrowserNotificationsToggled(ChangeEventArgs e)
    {
        var enabled = (bool)(e.Value ?? false);

        if (enabled)
        {
            var permission = await NotificationService.RequestBrowserPermissionAsync();
            if (permission == "granted")
            {
                SettingsService.BrowserNotificationsEnabled = true;
                browserNotificationsDenied = false;
            }
            else
            {
                SettingsService.BrowserNotificationsEnabled = false;
                browserNotificationsDenied = permission == "denied";
            }
        }
        else
        {
            SettingsService.BrowserNotificationsEnabled = false;
            browserNotificationsDenied = false;
        }

        StateHasChanged();
    }

    private async Task OpenBuyMeACoffee()
    {
        await JSRuntime.InvokeVoidAsync("open", "https://www.buymeacoffee.com/albertogregorio", "_blank");
    }

    private void RequestReset()
    {
        showConfirmation1 = true;
        StateHasChanged();
    }

    private void OnConfirm1(bool confirmed)
    {
        showConfirmation1 = false;
        if (confirmed)
        {
            showConfirmation2 = true;
        }

        StateHasChanged();
    }

    private async Task OnConfirm2(bool confirmed)
    {
        showConfirmation2 = false;
        if (confirmed)
        {
            await PerformReset();
        }

        StateHasChanged();
    }

    private async Task PerformReset()
    {
        try
        {
            await TimeService.ResetDataAsync();
            await TutorialService.ResetTutorialAsync();
            NavigationManager.NavigateTo("", forceLoad: true);
        }
        catch (Exception)
        {
            // Intentionally ignore to preserve existing UX behavior.
        }
    }
}
