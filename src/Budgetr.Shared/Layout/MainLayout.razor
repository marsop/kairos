@inherits LayoutComponentBase
@using Budgetr.Shared.Services
@inject IPwaService PwaService
@inject ITimeularService TimeularService
@inject IStringLocalizer<Strings> Localizer
@implements IDisposable

<div class="app-container">
    <main class="main-content">
        @if (!PwaService.IsOnline)
        {
            <div class="offline-banner">
                <span class="offline-icon">üì°</span>
                <span>@Localizer["OfflineBanner"]</span>
            </div>
        }
        
        @if (PwaService.IsInstallable)
        {
            <div class="install-prompt">
                <div class="install-content">
                    <span class="install-icon">üì±</span>
                    <div class="install-text">
                        <span class="install-title">@Localizer["InstallBudgetr"]</span>
                        <span class="install-desc">@Localizer["InstallDesc"]</span>
                    </div>
                </div>
                <button class="install-btn" @onclick="InstallApp">@Localizer["Install"]</button>
            </div>
        }

        @Body
        
        <Budgetr.Shared.Components.ToastContainer />
        <Budgetr.Shared.Components.TutorialOverlay />
    </main>
    
    <nav class="bottom-nav">
        <NavLink href="" class="nav-item" Match="NavLinkMatch.All">
            <span class="nav-icon">üè†</span>
            <span class="nav-label">@Localizer["NavOverview"]</span>
        </NavLink>
        <NavLink href="meters" class="nav-item">
            <span class="nav-icon">‚è±Ô∏è</span>
            <span class="nav-label">@Localizer["NavMeters"]</span>
        </NavLink>
        <NavLink href="timeline" class="nav-item">
            <span class="nav-icon">üìÖ</span>
            <span class="nav-label">@Localizer["NavTimeline"]</span>
        </NavLink>
        <NavLink href="history" class="nav-item">
            <span class="nav-icon">üìú</span>
            <span class="nav-label">@Localizer["NavHistory"]</span>
        </NavLink>
        <NavLink href="settings" class="nav-item">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span class="nav-label">@Localizer["NavSettings"]</span>
        </NavLink>
    </nav>
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        PwaService.OnStateChanged += StateHasChanged;
        
        await PwaService.InitializeAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await TimeularService.InitializeAsync();
        }
    }

    private async Task InstallApp()
    {
        await PwaService.InstallAppAsync();
    }

    public void Dispose()
    {
        PwaService.OnStateChanged -= StateHasChanged;
    }
}
