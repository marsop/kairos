@page "/meters"
@using Budgetr.Shared.Models
@using Budgetr.Shared.Services
@using Budgetr.Shared.Resources
@inject ITimeTrackingService TimeService
@inject IStringLocalizer<Strings> Localizer
@implements IDisposable

<div class="meters-page">
    <h2 class="page-title">@Localizer["NavMeters"]</h2>
    
    <div class="meters-grid">
        @{
            var orderedMeters = TimeService.Account.Meters.OrderBy(m => m.DisplayOrder).ToList();
        }
        @for (var index = 0; index < orderedMeters.Count; index++)
        {
            var meter = orderedMeters[index];
            var isActive = IsActiveMeter(meter.Id);
            var isEditing = _editingMeterId == meter.Id;
            var isDragging = _draggedMeter?.Id == meter.Id;
            var isDragOver = _dragTargetMeterId.HasValue && _dragTargetMeterId.Value == meter.Id && _draggedMeter?.Id != meter.Id;

            <div draggable="@(isEditing ? "false" : "true")"
                 class="meter-container @(isDragging ? "dragging" : "") @(isDragOver ? "drag-over" : "")"
                 @ondragstart="() => HandleDragStart(meter)"
                 @ondragenter="() => HandleDragEnter(meter)"
                 @ondragover="HandleDragOver"
                 @ondragover:preventDefault
                 @ondrop="() => HandleDrop(meter)"
                 @ondragend="HandleDragEnd"
                 @ondragleave="HandleDragLeave">
                @if (isEditing)
                {
                    <div class="meter-edit-form">
                        <input type="text" 
                               class="meter-name-input @(_validationError != null ? "invalid" : "")"
                               @bind="_editingMeterName"
                               @bind:event="oninput"
                               @onkeydown="HandleEditKeyDown"
                               @onblur="SaveEdit"
                               maxlength="40"
                               autofocus />
                        <div class="edit-actions">
                            <button class="edit-action-btn save" @onclick="SaveEdit" title="@Localizer["Save"]">‚úì</button>
                            <button class="edit-action-btn cancel" @onclick="CancelEdit" @onclick:stopPropagation="true" title="@Localizer["Cancel"]">‚úï</button>
                        </div>
                        @if (_validationError != null)
                        {
                            <div class="validation-error">@_validationError</div>
                        }
                        <div class="char-count @(_editingMeterName?.Length > 40 ? "over-limit" : "")">
                            @(_editingMeterName?.Length ?? 0)/40
                        </div>
                    </div>
                }
                else
                {
                    <button class="meter-button @(isActive ? "active" : "") @(meter.Factor >= 0 ? "positive" : "negative")"
                            @onclick="() => ToggleMeter(meter.Id)">
                        <div class="meter-index">#@(index + 1)</div>
                        <div class="meter-name">@meter.Name</div>
                        <div class="meter-factor">@Localizer["MeterFactor", meter.Factor.ToString("0.##")]</div>
                        <div class="meter-status">
                            @if (isActive)
                            {
                                <span class="pulse"></span>
                                <span>@Localizer["Running"]</span>
                            }
                            else
                            {
                                <span>@Localizer["TapToStart"]</span>
                            }
                        </div>
                    </button>
                    <div class="meter-actions">
                        <button class="meter-action-btn" @onclick="() => StartEditing(meter)" @onclick:stopPropagation="true" title="@Localizer["RenameMeter"]">
                            ‚úèÔ∏è
                        </button>
                        @if (!isActive)
                        {
                            <button class="meter-action-btn delete" @onclick="() => DeleteMeter(meter)" @onclick:stopPropagation="true" title="@Localizer["DeleteMeter"]">
                                üóëÔ∏è
                            </button>
                        }
                    </div>
                }
            </div>
        }
        
        @if (TimeService.Account.Meters.Count < Budgetr.Shared.Services.TimeTrackingService.MaxMeters)
        {
        <div class="meter-container add-meter">
            @if (_isAddingMeter)
            {
                <div class="meter-edit-form">
                    <input type="text" 
                           class="meter-name-input"
                           placeholder="@Localizer["Name"]"
                           @bind="_newMeterName"
                           maxlength="40"
                           autofocus />
                           
                    <input type="number" 
                           class="meter-factor-input"
                           placeholder="@Localizer["Factor"]"
                           step="0.1"
                           min="-10"
                           max="10"
                           @bind="_newMeterFactor" />
                           
                    <div class="edit-actions">
                        <button class="edit-action-btn save" @onclick="SaveNewMeter" title="@Localizer["Add"]">‚úì</button>
                        <button class="edit-action-btn cancel" @onclick="CancelAdd" title="@Localizer["Cancel"]">‚úï</button>
                    </div>
                    
                    @if (_addValidationError != null)
                    {
                        <div class="validation-error">@_addValidationError</div>
                    }
                </div>
            }
            else
            {
                <button class="meter-button add-meter-btn" @onclick="StartAdding">
                    <div class="add-icon">+</div>
                    <div class="add-text">@Localizer["AddMeter"]</div>
                </button>
            }
        </div>
        }
    </div>
    
    @if (ActiveEvent != null)
    {
        <div class="active-info">
            <div class="active-duration">
                <span class="label">@Localizer["RunningFor"]</span>
                <span class="value">@FormatDuration(ActiveEvent.Duration)</span>
            </div>
        </div>
    }
</div>

@code {
    private MeterEvent? ActiveEvent => TimeService.GetActiveEvent();
    
    private System.Threading.Timer? _timer;
    private Guid? _editingMeterId;
    private string? _editingMeterName;
    private string? _validationError;

    // Add Meter State
    private bool _isAddingMeter;
    private string _newMeterName = string.Empty;
    private double _newMeterFactor = 1.0;
    private string? _addValidationError;

    // Drag and Drop State
    private Meter? _draggedMeter;
    private Guid? _dragTargetMeterId;

    protected override void OnInitialized()
    {
        TimeService.OnStateChanged += StateHasChanged;
        
        // Update every second to show running duration
        _timer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(StateHasChanged);
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private bool IsActiveMeter(Guid meterId)
    {
        var activeEvent = ActiveEvent;
        if (activeEvent == null) return false;
        
        var meter = TimeService.Account.Meters.FirstOrDefault(m => m.Id == meterId);
        return meter != null && activeEvent.MeterName == meter.Name;
    }

    private void ToggleMeter(Guid meterId)
    {
        if (IsActiveMeter(meterId))
        {
            TimeService.DeactivateMeter();
        }
        else
        {
            TimeService.ActivateMeter(meterId);
        }
    }

    private void StartEditing(Meter meter)
    {
        _editingMeterId = meter.Id;
        _editingMeterName = meter.Name;
        _validationError = null;
        CancelAdd();
    }

    private void SaveEdit()
    {
        if (_editingMeterId == null || _editingMeterName == null)
        {
            CancelEdit();
            return;
        }

        var trimmedName = _editingMeterName.Trim();
        
        if (trimmedName.Length < 1 || trimmedName.Length > 40)
        {
            _validationError = Localizer["NameLengthError"];
            return;
        }

        try
        {
            TimeService.RenameMeter(_editingMeterId.Value, trimmedName);
            CancelEdit();
        }
        catch (ArgumentException ex)
        {
            _validationError = ex.Message;
        }
    }

    private void CancelEdit()
    {
        _editingMeterId = null;
        _editingMeterName = null;
        _validationError = null;
    }

    private void HandleEditKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            SaveEdit();
        }
        else if (e.Key == "Escape")
        {
            CancelEdit();
        }
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalHours >= 1)
        {
            return Localizer["DurationLong", (int)duration.TotalHours, duration.Minutes];
        }
        else if (duration.TotalMinutes >= 1)
        {
            return Localizer["DurationShort", (int)duration.TotalMinutes, duration.Seconds];
        }
        else
        {
            return Localizer["DurationSeconds", (int)duration.TotalSeconds];
        }
    }

    private void DeleteMeter(Meter meter)
    {
        if (IsActiveMeter(meter.Id)) return;
        TimeService.DeleteMeter(meter.Id);
    }
    
    // Add Meter Logic
    private void StartAdding()
    {
        _isAddingMeter = true;
        _newMeterName = string.Empty;
        _newMeterFactor = 1.0;
        _addValidationError = null;
        CancelEdit();
    }

    private void CancelAdd()
    {
        _isAddingMeter = false;
        _newMeterName = string.Empty;
        _addValidationError = null;
    }

    private void SaveNewMeter()
    {
        if (string.IsNullOrWhiteSpace(_newMeterName))
        {
            _addValidationError = Localizer["NameRequired"];
            return;
        }
        
        try
        {
            TimeService.AddMeter(_newMeterName, _newMeterFactor);
            CancelAdd();
        }
        catch (Exception ex)
        {
            _addValidationError = ex.Message;
        }
    }

    // Drag and Drop Handlers

    private void HandleDragStart(Meter meter)
    {
        _draggedMeter = meter;
        _dragTargetMeterId = null;
    }

    private void HandleDragEnter(Meter meter)
    {
        if (_draggedMeter == null || _draggedMeter.Id == meter.Id) return;
        _dragTargetMeterId = meter.Id;
    }

    private void HandleDragLeave()
    {
        // No-op: we only clear on DragEnd or Drop to avoid flicker from child elements
    }

    private void HandleDragOver(DragEventArgs e)
    {
        e.DataTransfer.DropEffect = "move";
    }

    private void HandleDragEnd()
    {
        _draggedMeter = null;
        _dragTargetMeterId = null;
    }

    private void HandleDrop(Meter targetMeter)
    {
        if (_draggedMeter == null || _draggedMeter.Id == targetMeter.Id)
        {
            _draggedMeter = null;
            _dragTargetMeterId = null;
            return;
        }

        // Compute the reorder: remove dragged from original position, insert at target position
        var meters = TimeService.Account.Meters.OrderBy(m => m.DisplayOrder).ToList();
        var draggedIndex = meters.FindIndex(m => m.Id == _draggedMeter.Id);
        var targetIndex = meters.FindIndex(m => m.Id == targetMeter.Id);

        if (draggedIndex != -1 && targetIndex != -1)
        {
            var dragged = meters[draggedIndex];
            meters.RemoveAt(draggedIndex);
            meters.Insert(targetIndex, dragged);
            TimeService.ReorderMeters(meters.Select(m => m.Id).ToList());
        }

        _draggedMeter = null;
        _dragTargetMeterId = null;
    }

    public void Dispose()
    {
        TimeService.OnStateChanged -= StateHasChanged;
        _timer?.Dispose();
    }
}
