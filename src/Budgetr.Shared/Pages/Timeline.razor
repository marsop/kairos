@page "/timeline"
@using Budgetr.Shared.Services
@using Budgetr.Shared.Resources
@using System.Globalization
@inject ITimeTrackingService TimeService
@inject IStringLocalizer<Strings> Localizer
@implements IDisposable

<div class="timeline-page">
    <h2 class="page-title">@Localizer["NavTimeline"]</h2>
    
    <div class="period-selector">
        @foreach (var period in Periods)
        {
            <button class="period-button @(TimeService.TimelinePeriod == period.Value ? "selected" : "")"
                    @onclick="() => SelectPeriod(period.Value)">
                @period.Label
            </button>
        }
    </div>
    
    <div class="chart-container">
        @((MarkupString)RenderChart())
    </div>
</div>

@code {
    private record PeriodOption(string Label, TimeSpan Value);
    
    private static readonly PeriodOption[] Periods = new[]
    {
        new PeriodOption("1h", TimeSpan.FromHours(1)),
        new PeriodOption("12h", TimeSpan.FromHours(12)),
        new PeriodOption("24h", TimeSpan.FromHours(24)),
        new PeriodOption("1w", TimeSpan.FromDays(7)),
        new PeriodOption("1m", TimeSpan.FromDays(30))
    };
    
    private List<TimelineDataPoint> DataPoints { get; set; } = new();
    
    private double MinY => DataPoints.Count > 0 ? Math.Min(0, DataPoints.Min(p => p.BalanceHours)) : 0;
    private double MaxY => DataPoints.Count > 0 ? Math.Max(0, DataPoints.Max(p => p.BalanceHours)) : 1;
    
    private string GradientColor => DataPoints.LastOrDefault()?.BalanceHours >= 0 ? "#10b981" : "#ef4444";
    
    private System.Threading.Timer? _timer;

    protected override void OnInitialized()
    {
        TimeService.OnStateChanged += RefreshData;
        RefreshData();
        
        // Refresh every 5 seconds
        _timer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                RefreshData();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private void SelectPeriod(TimeSpan period)
    {
        TimeService.TimelinePeriod = period;
        RefreshData();
    }

    private void RefreshData()
    {
        DataPoints = TimeService.GetTimelineData(TimeService.TimelinePeriod);
    }

    // Time window for the chart
    private DateTimeOffset StartTime => DateTimeOffset.UtcNow - TimeService.TimelinePeriod;
    private DateTimeOffset EndTime => DateTimeOffset.UtcNow;

    private double GetXFromTimestamp(DateTimeOffset timestamp)
    {
        var totalTicks = (EndTime - StartTime).Ticks;
        if (totalTicks == 0) return 400;
        
        var positionTicks = (timestamp - StartTime).Ticks;
        var ratio = (double)positionTicks / totalTicks;
        
        // Clamp to chart bounds [0, 1]
        ratio = Math.Clamp(ratio, 0.0, 1.0);
        
        // Map to chart X coordinates (50 to 750)
        return 50 + ratio * 700;
    }

    private double GetY(double value)
    {
        var range = MaxY - MinY;
        if (range == 0) range = 1;
        var normalized = (MaxY - value) / range;
        return 50 + normalized * 300;
    }


    private string LinePath
    {
        get
        {
            if (DataPoints.Count < 2) return "";
            var sb = new System.Text.StringBuilder();
            sb.Append(FormattableString.Invariant($"M {GetXFromTimestamp(DataPoints[0].Timestamp)} {GetY(DataPoints[0].BalanceHours)}"));
            for (int i = 1; i < DataPoints.Count; i++)
            {
                sb.Append(FormattableString.Invariant($" L {GetXFromTimestamp(DataPoints[i].Timestamp)} {GetY(DataPoints[i].BalanceHours)}"));
            }
            return sb.ToString();
        }
    }

    private string AreaPath
    {
        get
        {
            if (DataPoints.Count < 2) return "";
            var sb = new System.Text.StringBuilder();
            var firstX = GetXFromTimestamp(DataPoints[0].Timestamp);
            var lastX = GetXFromTimestamp(DataPoints[^1].Timestamp);
            sb.Append(FormattableString.Invariant($"M {firstX} {GetY(0)}"));
            sb.Append(FormattableString.Invariant($" L {firstX} {GetY(DataPoints[0].BalanceHours)}"));
            for (int i = 1; i < DataPoints.Count; i++)
            {
                sb.Append(FormattableString.Invariant($" L {GetXFromTimestamp(DataPoints[i].Timestamp)} {GetY(DataPoints[i].BalanceHours)}"));
            }
            sb.Append(FormattableString.Invariant($" L {lastX} {GetY(0)}"));
            sb.Append(" Z");
            return sb.ToString();
        }
    }

    private string RenderChart()
    {
        var sb = new System.Text.StringBuilder();
        sb.Append(@"<svg viewBox=""0 0 800 400"" class=""timeline-chart"" preserveAspectRatio=""xMidYMid meet"">");
        
        // Always show grid lines
        sb.Append(@"<g class=""grid-lines"">");
        for (int i = 0; i <= 4; i++)
        {
            var y = 50 + i * 75;
            sb.Append(FormattableString.Invariant($@"<line x1=""50"" y1=""{y}"" x2=""750"" y2=""{y}"" stroke=""#333"" stroke-dasharray=""4,4"" />"));
        }
        // Vertical grid lines
        for (int i = 0; i <= 4; i++)
        {
            var x = 50 + i * 175;
            sb.Append(FormattableString.Invariant($@"<line x1=""{x}"" y1=""50"" x2=""{x}"" y2=""350"" stroke=""#333"" stroke-dasharray=""4,4"" />"));
        }
        sb.Append("</g>");
        
        // Always show Y-axis labels
        sb.Append(@"<g class=""y-labels"">");
        var range = MaxY - MinY;
        if (range == 0) range = 1;
        for (int i = 0; i <= 4; i++)
        {
            var value = MaxY - (i * range / 4);
            var y = 50 + i * 75;
            sb.Append(FormattableString.Invariant($@"<text x=""45"" y=""{y + 5}"" text-anchor=""end"" fill=""#888"" font-size=""12"">{value:F1}h</text>"));
        }
        sb.Append("</g>");
        
        // Always show X-axis time labels
        sb.Append(@"<g class=""x-labels"">");
        var chartEndTime = DateTimeOffset.Now;
        var chartStartTime = chartEndTime - TimeService.TimelinePeriod;
        for (int i = 0; i <= 4; i++)
        {
            var x = 50 + i * 175; // 700 / 4 = 175
            var time = chartStartTime + TimeSpan.FromTicks((long)(TimeService.TimelinePeriod.Ticks * i / 4.0));
            var timeLabel = FormatTimeLabel(time);
            sb.Append(FormattableString.Invariant($@"<text x=""{x}"" y=""370"" text-anchor=""middle"" fill=""#888"" font-size=""11"">{timeLabel}</text>"));
        }
        sb.Append("</g>");
        
        // Gradient definitions (always needed)
        sb.Append($@"<defs>
            <linearGradient id=""areaGradient"" x1=""0"" x2=""0"" y1=""0"" y2=""1"">
                <stop offset=""0%"" stop-color=""{GradientColor}"" stop-opacity=""0.4"" />
                <stop offset=""100%"" stop-color=""{GradientColor}"" stop-opacity=""0"" />
            </linearGradient>
            <linearGradient id=""lineGradient"" x1=""0"" x2=""1"" y1=""0"" y2=""0"">
                <stop offset=""0%"" stop-color=""{GradientColor}"" />
                <stop offset=""100%"" stop-color=""{GradientColor}"" />
            </linearGradient>
        </defs>");
        
        // Data visualization (only when we have data)
        if (DataPoints.Count > 1)
        {
            // Area fill
            sb.Append($@"<path d=""{AreaPath}"" fill=""url(#areaGradient)"" opacity=""0.3"" />");
            
            // Line
            sb.Append($@"<path d=""{LinePath}"" fill=""none"" stroke=""url(#lineGradient)"" stroke-width=""3"" />");
            
            // Current value indicator
            if (DataPoints.Count > 0)
            {
                var lastPoint = DataPoints.Last();
                var x = GetXFromTimestamp(lastPoint.Timestamp);
                var y = GetY(lastPoint.BalanceHours);
                var valueText = lastPoint.BalanceHours >= 0 
                    ? FormattableString.Invariant($"+{lastPoint.BalanceHours:F2}h") 
                    : FormattableString.Invariant($"{lastPoint.BalanceHours:F2}h");
                sb.Append(FormattableString.Invariant($@"<circle cx=""{x}"" cy=""{y}"" r=""6"" fill=""{GradientColor}"" class=""pulse-circle"" />"));
                sb.Append(FormattableString.Invariant($@"<text x=""{x}"" y=""{y - 15}"" text-anchor=""middle"" fill=""{GradientColor}"" font-size=""14"" font-weight=""bold"">{valueText}</text>"));
            }
        }
        else
        {
            // Show "no data" message but keep the grid
            sb.Append($@"<text x=""400"" y=""200"" text-anchor=""middle"" fill=""#666"" font-size=""16"">{Localizer["NoDataPeriod"]}</text>");
        }
        
        sb.Append("</svg>");
        return sb.ToString();
    }

    private string FormatTimeLabel(DateTimeOffset time)
    {
        // Convert to local time for display
        var localTime = time.LocalDateTime;
        if (TimeService.TimelinePeriod.TotalHours <= 1)
        {
            return localTime.ToString("HH:mm");
        }
        else if (TimeService.TimelinePeriod.TotalHours <= 24)
        {
            return localTime.ToString("HH:mm");
        }
        else
        {
            return localTime.ToString("dd MMM");
        }
    }

    public void Dispose()
    {
        TimeService.OnStateChanged -= RefreshData;
        _timer?.Dispose();
    }
}
